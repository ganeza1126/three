<!DOCTYPE html>
<html lang="ja">
	<head>
		<title>Metaball</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				color: #ffffff;
				font-family:Monospace;
				font-size:13px;
				text-align:center;
				font-weight: bold;

				background-color: #000000;
				margin: 0px;
				overflow: hidden;
			}
		</style>
	</head>

	<body>
		<script src="../js_r79/three.min.js"></script>
		<script src="../js_r79/MarchingCubes.js"></script>
		<script src="../js_r79/OrbitControls.js"></script>

    <script>

// カメラの作成
camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 10000 );
camera.position.z = 1000;

// レンダラーの作成
var renderer = new THREE.WebGLRenderer();
// レンダラーが描画するキャンバスサイズの設定
renderer.setSize( window.innerWidth, window.innerHeight );
// キャンバスをDOMツリーに追加
document.body.appendChild( renderer.domElement );

// キューブマップ用のテクスチャ作成
var cubeTexture = new THREE.CubeTextureLoader()
	.setPath( 'sunflower/' )
	.load( [ 'sunflower_er_left.png', 'sunflower_er_right.png', 'sunflower_er_up.png', 'sunflower_er_down.png', 'sunflower_er_front.png', 'sunflower_er_back.png' ] );
cubeTexture.format = THREE.RGBFormat;

// シーンの作成
var scene = new THREE.Scene();
// シーンの背景テクスチャを設定
scene.background = cubeTexture;

// マテリアル作成
// 環境マップ（envmap）に作成したテクスチャ(cubeTexture)を設定
var material = new THREE.MeshStandardMaterial( { color: 0xdddddd, envMap: cubeTexture, roughness: 0.1, metalness: 0.5, transparent: true, opacity: 0.8 } );

// MarchingCubesインスタンスの作成
// 第1引数はresolutionで、値を大きくするほど滑らかな描画になる
var effect = new THREE.MarchingCubes( 64, material, true, true );
effect.position.set( 0, 0, 0 );
effect.scale.set( 1000, 1000, 1000 );

//effect.enableUvs = false;
//effect.enableColors = false;

// ボールサイズに影響？
// 大きくするとボールが小さくなる
// default: 80.0
//effect.isolation = 80.0;

// シーンに追加
scene.add( effect );

// 環境光の作成
var light = new THREE.AmbientLight( 0xffffff );
// 環境光をシーンへ追加
scene.add( light );

// OrbitControlsインスタンス作成
var controls = new THREE.OrbitControls( camera, renderer.domElement );
//contrls.target = new THREE.Vector3( 0, 1, 0 );

// Three.jsサンプル集にあるwebgl_marchingcubes.htmlのupdateCubesの一部を省いてほぼそのまま使用
// object: 作成したMarchingCubesインスタンス
// time: 経過時間の差分
// numblobs: 作成する球体の数
function updateCubes( object, time, numblobs) {

	object.reset();

	var i, ballx, bally, ballz, subtract, strength;

	// 大きくすると球体間の距離が大きくなる？
	subtract = 100;

	strength = 1.2 / ( ( Math.sqrt( numblobs ) - 1 ) / 4 + 1 );

	for ( i = 0; i < numblobs; i ++ ) {

		ballx = Math.sin( i + 1.26 * time * ( 1.03 + 0.5 * Math.cos( 0.21 * i ) ) ) * 0.27 + 0.5;
		bally = Math.abs( Math.cos( i + 1.12 * time * Math.cos( 1.22 + 0.1424 * i ) ) ) * 0.77;
		ballz = Math.cos( i + 1.32 * time * 0.1 * Math.sin( ( 0.92 + 0.53 * i ) ) ) * 0.27 + 0.5;

		// Adds a reciprocal ball (nice and blobby) that, to be fast, fades to zero after
		// a fixed distance, determined by strength and subtract.
		object.addBall( ballx, bally, ballz, strength, subtract );
	}
}

var time = 0;
var clock = new THREE.Clock();
// 球体の数
var numBlobs = 20;

function render(){
	requestAnimationFrame( render );

	var delta = clock.getDelta();

// メタボールの移動速度を調整
	time += delta * 0.1;

	controls.update( delta );

 // メタボールの作成
	updateCubes( effect, time, numBlobs );

	// レンダリング（表示）
	renderer.render(scene,camera);
}
render();

    </script>

  </body>

  </html>
